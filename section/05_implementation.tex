\chapter{システムの設計・実装}
\label{chap:implementation}

本章では、\ref{chap:network-transmission}章で述べた、映像制作現場におけるIP伝送装置について評価するため、4K映像を非圧縮でIPで伝送するシステムであるNG-HDMI-TSをハードウェアで実装したことについて実装の解説をする。

\section{実装の概要}

IP伝送装置は、Xilinx KC705 評価ボード\cite{xilinx-kc705}、HDMIインターフェースカードであるTED HDMI 2.0 FMCカード\cite{ted-hdmi4k}を使用した。
本実装の構成を図\ref{fig:fpga-implement-flow}に示す。

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 841 299,width=15.5cm]{img/fpga-implement-flow.pdf}
  \end{center}
  \caption{ハードウェアによる実装の構成}
  \label{fig:fpga-implement-flow}
\end{figure}

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 137 161,width=4cm]{img/ted-4k-fmc-card.jpg}
  \end{center}
  \caption{TED HDMI 2.0 FMCカード (TB-FMCH-HDMI4K)}
  \label{fig:ted-4k-fmc-card}
\end{figure}

\begin{table}[htbp]
  \caption{ソフトウェアによる実装を検証したPCの構成}
  \label{tb:software-specification}
  \begin{center}
  \begin{tabular}{c||c}
    \hline
    OS  & Ubuntu 14.04 Desktop \\\hline
    CPU & Intel Core i7-4770 @ 3.40GHz \\\hline
    RAM & 8GB                  \\\hline
  \end{tabular}\end{center}
\end{table}

今回の構成では、IP伝送装置とは別に1台のXilinx KC705 評価ボード、Quad SFP/SFP+カードを用いて、送信したIPパケットを折り返しする装置を使用した。
IPパケットを折り返しする装置について、IP伝送装置と直接の関係はないため、ここでの解説は割愛する。

\section{FPGAの回路設計}

本実装では、Xilinxの提供するIPである10 Gigabit Ethernet Subsystem\cite{xilinx-pg157}、Video PHY Controller\cite{xilinx-pg230}、HDMI 1.4/2.0 Transmitter Subsystem\cite{xilinx-pg235}、及び、HDMI 1.4/2.0 Receiver Subsystem\cite{xilinx-pg236}、FIFO Generator\cite{xilinx-pg057}を用いた。
本研究のために、新たに実装をした箇所は、これらのIPに対してデータを受け渡しするモジュールとなる。

Xilinxが提供しているKintex-7シリーズ向けのHDMI 2.0のリファレンス実装であるxapp1287\cite{xilinx-xapp1287}をベースとている。
FPGAの回路全体のブロックダイアグラムを図\label{fig:fpga-whole-diagram}に示す。

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 452 229,width=15.5cm]{img/fpga-whole-diagram.pdf}
  \end{center}
  \caption{FPGA回路全体のブロックダイアグラム}
  \label{fig:fpga-whole-diagram}
\end{figure}

\newpage
受信側と送信側で、10 Gigabit Ethernet SubsystemとVideo Processing Subsystem間の受け渡しを行うため、次の4つのモジュールを実装した。

\begin{table}[htbp]
  \caption{10 Gigabit Ethernet Subsystem、及び、Video Processing Subsystemの接続のために実装したモジュール}
  \label{tb:fpga-implement-modules}
  \begin{center}
  \begin{tabular}{c|p{12cm}}
    \hline
    Name               & Description \\\hline\hline
    v\_axi4s\_eth2fifo.v & Ethernet Subsystemのクロックで、Ethernet Subsystemから送られてきた映像データをFIFOに書き込むモジュール \\\hline
    v\_axi4s\_fifo2eth.v & Ethernet Subsystemのクロックで、FIFOから読み込んだの映像データをEthernet Subsystemに送るモジュール \\\hline
    v\_axi4s\_vid2fifo.v & Video Processing Subsystemのクロックで、Video Processing Subsystemから送られてきた映像データをFIFOに書き込むモジュール \\\hline
    v\_axi4s\_fifo2vid.v & Video Processing Subsystemのクロックで、FIFOから読み込んだの映像データをVideo Processing Subsystemに送るモジュール \\\hline
  \end{tabular}\end{center}
\end{table}

10 Gigabit Ethernet Subsystemの基準クロックは64bit幅の設定で156.25MHzとなり、Video Processing Subsystemの基準クロックは300MHzとなる。
互いの基準クロックが異なるため、データをそのまま受け渡しすることはできない。

この問題を解決するため、読み書きで独立したクロックに対応したIndependent Clocking FIFOをFIFO Generatorで作成する。
今回のIP伝送装置の送信側で用いた、FIFOのモジュールを図\ref{fig:fpga-independent-clocking-fifo}に示す。

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 201 371,width=4cm]{img/fpga-independent-clocking-fifo.pdf}
  \end{center}
  \caption{Independent Clocking FIFO}
  \label{fig:fpga-independent-clocking-fifo}
\end{figure}

\newpage
読み書きで独立したクロックの他に、入出力のデータ幅が異なっており、入力のデータ幅は35bit、出力のデータ幅は倍の70bitとなっている。
Video Processing Subsystemは300MHzで35bitのデータを書き込み、10 Gigabit Ethernet Subsystemは156.25MHzのデータを読み込むため、
Ethernet Subsystemのほうがクロックが早いため、FIFOがフル状態になることはない。
また、almost\_emptyフラグを使用しており、emptyになる1クロック前に知ることが可能である。

送信側のモジュールの接続を図\ref{fig:fpga-video-ethernet-diagram}に示す。

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 911 166,width=15.5cm]{img/fpga-video-ethernet-diagram.pdf}
  \end{center}
  \caption{Video Stream to Ethernet Packet Subsystem Diagram}
  \label{fig:fpga-video-ethernet-diagram}
\end{figure}

受信側のモジュールの接続を図\ref{fig:fpga-ethernet-video-diagram}に示す。

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 911 166,width=15.5cm]{img/fpga-ethernet-video-diagram.pdf}
  \end{center}
  \caption{Ethernet Packet to Video Stream Subsystem Diagram}
  \label{fig:fpga-ethernet-video-diagram}
\end{figure}

Video Processing Subsystemが出力するAxi4-Streamのtdataが映像データを表し、有効データ幅は32bitである。
また、表\ref{tb:fpga-axi4-stream}に示すとおり、tlastがラインの終了、tuserがフレームの開始を表す。
FIFOに映像データだけを書き込んだ場合、ラインの終了、フレームの開始のタイミングが失われることとなる。
この問題を解決するため、FIFOにはAxi4-Streamのtdata、tlast, tuser, tvalidを書き込む。

\begin{table}[htbp]
  \caption{Video Processing SubsystemのAxi4-Streamインターフェース}
  \label{tb:fpga-axi4-stream}
  \begin{center}
  \begin{tabular}{l|c|l}
    \hline
    Name   & Width     & Description \\\hline\hline
    tdata  & 3*BPC\footnote{Max Bits Per Component}*PPC\footnote{Pixels Per Clock} & Data \\\hline
    tlast  & 1         & End of line \\\hline
    tready & 1         & Ready \\\hline
    tuser  & 1         & Start of frame \\\hline
    tvalid & 1         & Valid \\\hline
  \end{tabular}\end{center}
\end{table}

% どちらもAxi4-Stream規格での通信となるが、

% 表\ref{tb:pg236-vout-axi4-stream}
% 表\ref{tb:pg235-vin-axi4-stream}

% Axi4-Stream、tuser
% 図\ref{fig:fpga-video-ethernet-diagram}
% 図\ref{fig:fpga-ethernet-video-diagram}

% Xilinxの 10 Gigabit Ethernet Subsystem、及び、Video Processing Subsystem
% これを解決するため、Xilinxの 10 Gigabit Ethernet Subsystem、及び、Video Processing Subsystem


% また、

% 10 Gigabit Ethernet Subsystemの挙動に空いては、Xilinx PG157\cite{xilinx-pg157}を参照されたし。
% \cite{xilinx-pg235}
% \cite{xilinx-pg236}

% \begin{table}[htbp]
%   \caption{HDMI RX SubsystemのAxi4-Streamインターフェース \cite{xilinx-pg236}より抜粋}
%   \label{tb:pg236-vout-axi4-stream}
%   \begin{center}
%   \begin{tabular}{l|c|c|l}
%     \hline
%     Name   & Direction & Width     & Description \\\hline\hline
%     tdata  & Output    & 3*BPC\footnote{Max Bits Per Component}*PPC\footnote{Pixels Per Clock} & Data \\\hline
%     tlast  & Output    & 1         & End of line \\\hline
%     tready & Input     & 1         & Ready \\\hline
%     tuser  & Output    & 1         & Start of frame \\\hline
%     tvalid & Output    & 1         & Valid \\\hline
%   \end{tabular}\end{center}
% \end{table}
%
%
% \begin{table}[htbp]
%   \caption{HDMI TX SubsystemのAxi4-Streamインターフェース \cite{xilinx-pg235}より抜粋}
%   \label{tb:pg235-vin-axi4-stream}
%   \begin{center}
%   \begin{tabular}{l|c|c|l}
%     \hline
%     Name   & Direction & Width     & Description \\\hline\hline
%     tdata  & Input     & 3*BPC*PPC & Data \\\hline
%     tlast  & Input     & 1         & End of line \\\hline
%     tready & Output    & 1         & Ready \\\hline
%     tuser  & Input     & 1         & Start of frame \\\hline
%     tvalid & Input     & 1         & Valid \\\hline
%   \end{tabular}\end{center}
% \end{table}

図\ref{fig:fpga-video-packet}に、本実装で用いたパケット構造を示す。
UDPのペイロードのビデオデータより前の区間が6byteなのは、Ethernetパケットを構築していく際に、ペイロードの先頭6byte目が丁度64bitの区切り目となるため、FPGAで処理する祭に効率が良いためである。

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 643 122,width=15.5cm]{img/fpga-video-packet.pdf}
  \end{center}
  \caption{UDPペイロードのパケット構造}
  \label{fig:fpga-video-packet}
\end{figure}

また、UDPのパケットはFIFOにデータがある間生成され続けるため、IPパケット上の長さは00とし、ジャンボフレームとなる場合もある。

また、図\ref{fig:fpga-ila-fifo-to-eth}、図\ref{fig:fpga-ila-hdmi}では、本実装を稼働させたときのILA（Integrated Logic Analyzer）とよばれる、FPGAの内部信号をモニターするためのツールを使った際の様子である。

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 612 792,width=15.5cm]{img/ethlogic_template_ss.pdf}
  \end{center}
  \caption{ブロック}
  \label{fig:ethlogic_template_ss}
\end{figure}

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 1201 438,width=15.5cm]{img/fpga-ila-fifo-to-eth.png}
  \end{center}
  \caption{ILAによるIP伝送時のFIFOとEthernet Subsystemのデータのダンプ}
  \label{fig:fpga-ila-fifo-to-eth}
\end{figure}

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 1199 246,width=15.5cm]{img/fpga-ila-hdmi.png}
  \end{center}
  \caption{ILAによるIP伝送時のHDMI入出力のデータのダンプ}
  \label{fig:fpga-ila-hdmi}
\end{figure}

\begin{figure}[htbp]
  \begin{center}
    % \fbox{
    \includegraphics[bb=0 0 1062 501,width=22.5cm,angle=270]{img/fpga-waveform.pdf}
    % }
  \end{center}
  \caption{ILAによるIP伝送時のHDMI入出力のデータのダンプ}
  \label{fig:fpga-waveform}
\end{figure}

% \begin{figure}[htbp]
%     \begin{center}
%         \includegraphics[bb=0 0 1197 246,width=15.5cm]{img/fpga-ila-hdmi-x2.png}
%     \end{center}
%     \caption{図\ref{fig:fpga-ila-hdmi}を拡大した}
%     \label{fig:fpga-ila-hdmi-x2}
% \end{figure}

特殊なバッファリング機構は用意していないが、FIFOにデータが入っているかを示す信号（almost\_emptyの立ち下がり）を合図に、パケットを生成する祭に一定のクロックが経過するため、その分のFIFOへの書き込みのバッファリングが行われる。
そのため、図\ref{fig:fpga-ila-hdmi}では、hdmi\_rx\_tvalidが頻繁に立ち上がりと立ち下がりを繰り返しているのに対し、hdmi\_tx\_tvalidはある程度まとまった周期で立ち上がりをしているのが確認できる。
