\chapter{評価}
\label{chap:evaluation}

\ref{chap:network-transmission}章ての映像制作現場におけるIP伝送装置の要件に基づいて、ソフトウェア、ハードウェアそれぞれIP伝送装置の実装を行った。
本章ではアプローチが有効な手法であるか、それぞれの項目について評価する。

\section{概要}

\ref{chap:software-experimentation}章と\ref{chap:implementation}章で実装したIP伝送装置を動作させ、それぞれの項目について評価を行う。

% AAA

\section{トラフィック}

本節では、実装したIP伝送装置が理想通りにパケットの送信を行っているかを確認するために、Linux PCを用いてトラフィックを計測した。

\subsection{計測手法}

ソフトウェア実装の場合はにおける受信PC、ハードウェア実装の場合はIP分配折り返しボードに接続されたデバッグ用のPCで、受信バイト数、受信パケット数、破棄パケット数を計測した。
ネットワークインターフェースの情報は/proc/net/devを監視した。rrdtoolを使い集計し、グラフとして出力した。

\subsection{計測結果}

ソフトウェア実装における計測結果を、図\ref{fig:lo-bytes-graph}と\ref{fig:lo-packets-graph}に示す。

図\ref{fig:lo-bytes-graph}で示した受信バイトのグラフでは、平均489MBpsとなっている。
ソフトウェア実装での映像データはYCbCr 4:2:2の色深度が16bitであるため、ピクセルあたり2bytesとなる。% また、フレームレートは30Pである。
理想的な1秒あたりの受信バイト数は、次のように求められる。

\[ 3840 * 2160 * 2 * 30 = 497664000 \]

理想的な1秒あたりの受信バイト数を満たしていない。
この原因としては、送信PCがデータの送信に追いつかない場合に自動的にフレームをドロップさせる処理によるものだと考えられる。

ハードウェア実装における計測結果を、図\ref{fig:enp2s0f1-bytes-graph}と\ref{fig:enp2s0f1-packets-graph}に示す。

図\ref{fig:enp2s0f1-packets-graph}で示した受信パケットのグラフでは、パケットがドロップしている事が確認できる。
これは、カーネルのネットワーク処理が、FPGAのハードウェアによる出力の速度に追いつけなかったためだと考えられる。
ハードウェア実装での映像データはYUV 422でピクセルあたり12bitとなる。
理想的な1秒あたりの受信バイト数は、次のように求められる。

\[ 3840 * 2160 * 3 / 2 * 30 = 373248000 \]

% 176*5437845 = 957060720

1パケットあたりの平均バイト数は、次のように求められる。

\[ 694800066.36 / 5437845.10 = 127.77 \]

そのため、本来PCが受信してたであろうバイト数は、次のように求められる。

\[ (5437845.10 + 1494269.10) * 127.77 = 885716231 \]

127.77-56

0.5617

% 694800066.36/(5437845.10-1494269.10) = 176.bytes


% HDMIのデータとなるので、4:2:2でもRGBと帯域は変わらない
% 3840 * 2160 * 4 * 30=
%
% 694800066/5437845
% 平均127.77bytesのパケットとなる
%
% 190,924,575bytes
%
% 885,724,641bytesではないか
%
% 1-(14/127.77)=0.890
% 1-(56/127.77)=0.561

\newpage
\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 597 374,width=11.8cm]{img/lo-bytes-graph.png}
  \end{center}
  \caption{ソフトウェア実装における伝送中の受信バイトのグラフ}
  \label{fig:lo-bytes-graph}
\end{figure}

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 597 388,width=11.8cm]{img/lo-packets-graph.png}
  \end{center}
  \caption{ソフトウェア実装における伝送中の受信パケットのグラフ}
  \label{fig:lo-packets-graph}
\end{figure}

\newpage
\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 597 374,width=11.8cm]{img/enp2s0f1-bytes-graph.png}
  \end{center}
  \caption{ハードウェア実装における伝送中の受信バイトのグラフ}
  \label{fig:enp2s0f1-bytes-graph}
\end{figure}

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 597 388,width=11.8cm]{img/enp2s0f1-packets-graph.png}
  \end{center}
  \caption{ハードウェア実装における伝送中の受信パケットのグラフ}
  \label{fig:enp2s0f1-packets-graph}
\end{figure}


\newpage
\section{遅延}

遅延を計測した

\subsection{計測手法}

映像機器の遅延を計測するため、テスト信号生成、マルチビューワー生成、画面キャプチャーの機能を有する機器を用意した。
遅延を計測した機器の構成を図\ref{fig:evaluate-diagram}に示す。

テスト信号生成では、フレーム単位のタイムコードが表示された同じソースの映像を2つの信号として出力する。
一方をスイッチャーへ入力し、もう一方を検査対象となる機器に入力し、その出力をスイッチャーへ入力する。
これにより、2つの信号の遅延は、検査対象となる機器で発生した遅延に抑えることができる。
スイッチャーに入力された2つの信号はマルチビューワーとして1つの画面に表示され、その画面をキャプチャーすることにより、ある瞬間の2つの信号を1つの画像で確認することができる。
このスイッチャーには、フレーム同期の機能があり、1フレームより短い期間でバッファリングされるため、計測できる粒度はフレーム単位となる。

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 697 212,width=15cm]{img/evaluate-diagram.pdf}
  \end{center}
  \caption{遅延の計測手法}
  \label{fig:evaluate-diagram}
\end{figure}

\subsection{計測結果}

aaa

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 1920 540,width=14cm]{img/evaluate-delay-software-1.png}
  \end{center}
  \caption[ソフトウェア実装による遅延計測のキャプチャー画像]{ソフトウェア実装による遅延計測のキャプチャー画像 左がオリジナルの信号、右が検査対象の信号}
  \label{fig:evaluate-delay-software-1}
\end{figure}

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 1920 540,width=14cm]{img/evaluate-delay-software-2.png}
  \end{center}
  \caption[ソフトウェア実装による遅延計測のキャプチャー画像]{ソフトウェア実装による遅延計測のキャプチャー画像 左がオリジナルの信号、右が検査対象の信号}
  \label{fig:evaluate-delay-software-2}
\end{figure}

\begin{figure}[htbp]
  \begin{center}
    \includegraphics[bb=0 0 1920 540,width=14cm]{img/evaluate-delay-hardware.png}
  \end{center}
  \caption[ハードウェア実装による遅延計測のキャプチャー画像]{ハードウェア実装による遅延計測のキャプチャー画像 左がオリジナルの信号、右が検査対象の信号}
  \label{fig:evaluate-delay-hardware}
\end{figure}

\section{YCbCr 4:2:0}
あああ


% \begin{table}[htbp]
%   \caption{ソフトウェア実装による30FPSにおける遅延時間}
%   \label{tb:pg235-vin-axi4-stream}
%   \begin{center}
%   \begin{tabular}{l|c|c}
%     \hline
%          & 遅延時間  & 遅延フレーム \\\hline\hline
%     1回目 & 300 ms  & 9 frames \\\hline
%     1回目 & 300 ms  & 9 frames \\\hline
%     1回目 & 300 ms  & 9 frames \\\hline
%     1回目 & 300 ms  & 9 frames \\\hline
%     1回目 & 300 ms  & 9 frames \\\hline
%     1回目 & 300 ms  & 9 frames \\\hline
%     1回目 & 300 ms  & 9 frames \\\hline
%     1回目 & 300 ms  & 9 frames \\\hline
%     1回目 & 300 ms  & 9 frames \\\hline
%     1回目 & 300 ms  & 9 frames \\\hline
%     1回目 & 300 ms  & 9 frames \\\hline
%     1回目 & 300 ms  & 9 frames \\\hline
%     1回目 & 300 ms  & 9 frames \\\hline
%     1回目 & 300 ms  & 9 frames \\\hline\hline
%     平均  & 300 ms  & 9 frames \\\hline
%   \end{tabular}\end{center}
% \end{table}

% \section{実証実験}
% 本実装に実用性があることを顕彰するため、ORF2015とORF2016でそれぞれ実証実験を行った。
% 付録\ref{chap:orf2015}、付録\ref{chap:orf2016}

\section{考察}
