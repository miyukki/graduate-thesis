\section{ハードウェアによる実装}

ハードウェアによる実装では、Xilinx KC705 評価ボード、HDMIインターフェースカード TED HDMI 2.0 FMCカードを用いて行った。
本実装の概要を、図\ref{fig:fpga-implement-flow}に示す。

\begin{figure}[htbp]
    \begin{center}
        \includegraphics[bb=0 0 841 299,width=15.5cm]{img/fpga-implement-flow.pdf}
    \end{center}
    \caption{ハードウェアによる実装の構成}
    \label{fig:fpga-implement-flow}
\end{figure}

\begin{figure}[htbp]
    \begin{center}
        \includegraphics[bb=0 0 137 161,width=4cm]{img/ted-4k-fmc-card.jpg}
    \end{center}
    \caption{TED HDMI 2.0 FMCカード (TB-FMCH-HDMI4K)}
    \label{fig:ted-4k-fmc-card}
\end{figure}

\subsection{FPGAの回路設計}

本実装では、Xilinxの 10 Gigabit Ethernet Subsystem、及び、Video Processing Subsystemを用いた。

% 表\ref{tb:pg236-vout-axi4-stream}
% 表\ref{tb:pg235-vin-axi4-stream}

% Axi4-Stream、tuser
% 図\ref{fig:fpga-video-ethernet-diagram}
% 図\ref{fig:fpga-ethernet-video-diagram}

% Xilinxの 10 Gigabit Ethernet Subsystem、及び、Video Processing Subsystem
% これを解決するため、Xilinxの 10 Gigabit Ethernet Subsystem、及び、Video Processing Subsystem

しかし、10 Gigabit Ethernet Subsystemは156.25MHzとなり、Video Processing Subsystemでは300MHzとなる。
そのため、読み書きで独立したクロックに対応したFIFOを使用する。

% また、

% 10 Gigabit Ethernet Subsystemの挙動に空いては、Xilinx PG157\cite{xilinx-pg157}を参照されたし。
% \cite{xilinx-pg235}
% \cite{xilinx-pg236}

% \begin{table}[htbp]
%   \begin{minipage}[t]{0.5\hsize}
%     \caption{HDMI RX SubsystemのAxi4-Streamインターフェース \cite{xilinx-pg236}より抜粋}
%     \label{tb:pg236-vout-axi4-stream}
%     \begin{center}
%     \begin{tabular}{l|c|c|l}
%       \hline
%       Name   & Direction & Width     & Description \\\hline\hline
%       tdata  & Output    & 3* BPC*PPC & Data \\\hline
%       tlast  & Output    & 1         & End of line \\\hline
%       tready & Input     & 1         & Ready \\\hline
%       tuser  & Output    & 1         & Start of frame \\\hline
%       tvalid & Output    & 1         & Valid \\\hline
%     \end{tabular}\end{center}
%   \end{minipage}
%   \begin{minipage}[t]{0.5\hsize}
%     \caption{HDMI TX SubsystemのAxi4-Streamインターフェース \cite{xilinx-pg235}より抜粋}
%     \label{tb:pg235-vin-axi4-stream}
%     \begin{center}
%     \begin{tabular}{l|c|c|l}
%       \hline
%       Name   & Direction & Width     & Description \\\hline\hline
%       tdata  & Input     & 3* BPC*PPC & Data \\\hline
%       tlast  & Input     & 1         & End of line \\\hline
%       tready & Output    & 1         & Ready \\\hline
%       tuser  & Input     & 1         & Start of frame \\\hline
%       tvalid & Input     & 1         & Valid \\\hline
%     \end{tabular}\end{center}
%   \end{minipage}
% \end{table}

\begin{table}[htbp]
  \caption{HDMI RX SubsystemのAxi4-Streamインターフェース \cite{xilinx-pg236}より抜粋}
  \label{tb:pg236-vout-axi4-stream}
  \begin{center}
  \begin{tabular}{l|c|c|l}
    \hline
    Name   & Direction & Width     & Description \\\hline\hline
    tdata  & Output    & 3*BPC*PPC & Data \\\hline
    tlast  & Output    & 1         & End of line \\\hline
    tready & Input     & 1         & Ready \\\hline
    tuser  & Output    & 1         & Start of frame \\\hline
    tvalid & Output    & 1         & Valid \\\hline
  \end{tabular}\end{center}
\end{table}

\begin{table}[htbp]
  \caption{HDMI TX SubsystemのAxi4-Streamインターフェース \cite{xilinx-pg235}より抜粋}
  \label{tb:pg235-vin-axi4-stream}
  \begin{center}
  \begin{tabular}{l|c|c|l}
    \hline
    Name   & Direction & Width     & Description \\\hline\hline
    tdata  & Input     & 3*BPC*PPC & Data \\\hline
    tlast  & Input     & 1         & End of line \\\hline
    tready & Output    & 1         & Ready \\\hline
    tuser  & Input     & 1         & Start of frame \\\hline
    tvalid & Input     & 1         & Valid \\\hline
  \end{tabular}\end{center}
\end{table}

\begin{figure}[htbp]
    \begin{center}
        \includegraphics[bb=0 0 911 166,width=15.5cm]{img/fpga-video-ethernet-diagram.pdf}
    \end{center}
    \caption{Video Stream to Ethernet Packet Subsystem Diagram}
    \label{fig:fpga-video-ethernet-diagram}
\end{figure}

\begin{figure}[htbp]
    \begin{center}
        \includegraphics[bb=0 0 911 166,width=15.5cm]{img/fpga-ethernet-video-diagram.pdf}
    \end{center}
    \caption{Ethernet Packet to Video Stream Subsystem Diagram}
    \label{fig:fpga-ethernet-video-diagram}
\end{figure}

図\ref{fig:fpga-video-packet}に、本実装で用いたパケット構造を示す。
UDPのペイロードのビデオデータより前の区間が6byteなのは、Ethernetパケットを構築していく際に、ペイロードの先頭6byte目が丁度64bitの区切り目となるため、FPGAで処理する祭に効率が良いためである。

\begin{figure}[htbp]
    \begin{center}
        \includegraphics[bb=0 0 643 122,width=15.5cm]{img/fpga-video-packet.pdf}
    \end{center}
    \caption{UDPペイロードのパケット構造}
    \label{fig:fpga-video-packet}
\end{figure}

また、図\ref{fig:fpga-ila-fifo-to-eth}、図\ref{fig:fpga-ila-hdmi}では、本実装を稼働させたときのILA（Integrated Logic Analyzer）とよばれる、FPGAの内部信号をモニターするためのツールを使った際の様子である。

\begin{figure}[htbp]
    \begin{center}
        \includegraphics[bb=0 0 612 792,width=15.5cm]{img/ethlogic_template_ss.pdf}
    \end{center}
    \caption{ブロック}
    \label{fig:ethlogic_template_ss}
\end{figure}

\begin{figure}[htbp]
    \begin{center}
        \includegraphics[bb=0 0 1201 438,width=15.5cm]{img/fpga-ila-fifo-to-eth.png}
    \end{center}
    \caption{ILAによるIP伝送時のFIFOとEthernet Subsystemのデータのダンプ}
    \label{fig:fpga-ila-fifo-to-eth}
\end{figure}

\begin{figure}[htbp]
    \begin{center}
        \includegraphics[bb=0 0 1199 246,width=15.5cm]{img/fpga-ila-hdmi.png}
    \end{center}
    \caption{ILAによるIP伝送時のHDMI入出力のデータのダンプ}
    \label{fig:fpga-ila-hdmi}
\end{figure}

% \begin{figure}[htbp]
%     \begin{center}
%         \includegraphics[bb=0 0 1197 246,width=15.5cm]{img/fpga-ila-hdmi-x2.png}
%     \end{center}
%     \caption{図\ref{fig:fpga-ila-hdmi}を拡大した}
%     \label{fig:fpga-ila-hdmi-x2}
% \end{figure}

特殊なバッファリング機構は用意していないが、FIFOにデータが入っているかを示す信号（almost\_emptyの立ち下がり）を合図に、パケットを生成する祭に一定のクロックが経過するため、その分のFIFOへの書き込みのバッファリングが行われる。
そのため、図\ref{fig:fpga-ila-hdmi}では、hdmi\_rx\_tvalidが頻繁に立ち上がりと立ち下がりを繰り返しているのに対し、hdmi\_tx\_tvalidはある程度まとまった周期で立ち上がりをしているのが確認できる。
